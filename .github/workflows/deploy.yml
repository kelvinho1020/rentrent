name: Deploy to VPS

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Connect & Deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        script: |
          cd ~/rentrent
          git pull origin master
          
          echo "🛠️ Rebuilding containers..."
          # 強制重新構建前後端
          docker compose -f docker-compose.prod.yml up -d --build --force-recreate frontend
          docker compose -f docker-compose.prod.yml up -d --build backend

          echo "📦 Running Prisma migration..."

          echo "📥 Importing listings..."
          docker exec rentrent-backend-prod node /app/apps/backend/dist/scripts/import-listings.js /app/apps/backend/data/crawl_result_current.json 
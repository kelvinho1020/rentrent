name: Deploy to VPS

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Connect & Deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        script: |
          cd ~/rentrent
          git pull origin master

          echo "ğŸ§¹ Cleaning up old containers..."
          # åœæ­¢ä¸¦ç§»é™¤æ‰€æœ‰å®¹å™¨
          docker compose -f docker-compose.prod.yml down --remove-orphans || true
          # ç¢ºä¿æ‰€æœ‰å®¹å™¨éƒ½è¢«ç§»é™¤
          docker rm -f rentrent-frontend-prod rentrent-backend-prod || true
          
          echo "ğŸ› ï¸ Rebuilding containers..."
          # é‡æ–°å»ºç½®ä¸¦å•Ÿå‹•æ‰€æœ‰æœå‹™
          docker compose -f docker-compose.prod.yml up -d --build

          echo "â³ Waiting for services to be ready..."
          sleep 30  # ç­‰å¾…æœå‹™å®Œå…¨å•Ÿå‹•

          echo "ğŸ“¦ Running Prisma migration..."
          # åœ¨é€™è£¡ä¸éœ€è¦åŸ·è¡Œé·ç§»ï¼Œå› ç‚º start.sh å·²ç¶“è™•ç†äº†

          echo "ğŸ“¥ Importing listings..."
          docker exec rentrent-backend-prod pnpm ts-node -T --skip-project /app/apps/backend/scripts/import-listings.ts /app/apps/backend/data/crawl_result_current.json 
# ç§Ÿå±‹è³‡æ–™æ›´æ–°ç­–ç•¥ - è»Ÿåˆªé™¤æœ€ä½³å¯¦è¸

## ğŸ“‹ èƒŒæ™¯

ç§Ÿå±‹è³‡æ–™æ¯å¤©éƒ½åœ¨è®ŠåŒ–ï¼Œéœ€è¦ä¸€å€‹å¯é çš„æ›´æ–°ç­–ç•¥ä¾†ä¿æŒè³‡æ–™çš„æ–°é®®åº¦ï¼ŒåŒæ™‚é¿å…è³‡æ–™ä¸Ÿå¤±å’Œæœå‹™ä¸­æ–·ã€‚

## âŒ èˆŠåšæ³•çš„å•é¡Œï¼ˆå…¨é‡åˆªé™¤ï¼‰

- **è³‡æ–™å®‰å…¨é¢¨éšª**ï¼šçˆ¬å–å¤±æ•—æœƒä¸Ÿå¤±æ‰€æœ‰è³‡æ–™
- **é€šå‹¤æ™‚é–“æµå¤±**ï¼šå·²è¨ˆç®—çš„æ˜‚è²´é€šå‹¤æ™‚é–“æ•¸æ“šæœƒä¸Ÿå¤±
- **ç”¨æˆ¶é«”é©—å·®**ï¼šæ›´æ–°æœŸé–“ç¶²ç«™æ²’æœ‰è³‡æ–™å¯é¡¯ç¤º
- **ç„¡æ³•å›æ»¾**ï¼šå‡ºå•é¡Œæ™‚ç„¡æ³•æ¢å¾©
- **é‹ç‡Ÿæˆæœ¬é«˜**ï¼šéœ€è¦é‡æ–°è¨ˆç®—æ‰€æœ‰é€šå‹¤æ™‚é–“

## âœ… æ–°ç­–ç•¥ï¼šè»Ÿåˆªé™¤ + æ‰¹æ¬¡æ›´æ–°

### æ ¸å¿ƒæ¦‚å¿µ

ä½¿ç”¨è³‡æ–™åº«ä¸­çš„ `isActive` æ¬„ä½å¯¦ç¾è»Ÿåˆªé™¤ï¼Œç¢ºä¿è³‡æ–™æ›´æ–°çš„åŸå­æ€§å’Œå®‰å…¨æ€§ã€‚

### æ›´æ–°æµç¨‹

```mermaid
graph TD
    A[é–‹å§‹æ›´æ–°] --> B[æ¨™è¨˜æ‰€æœ‰ç¾æœ‰è³‡æ–™ç‚º inactive]
    B --> C[çˆ¬å–æœ€æ–°è³‡æ–™]
    C --> D[åŒ¯å…¥æ–°è³‡æ–™ç‚º active]
    D --> E[é©—è­‰æ›´æ–°æˆåŠŸ]
    E --> F{æ›´æ–°æˆåŠŸ?}
    F -->|æ˜¯| G[æ™ºæ…§æ¸…ç†éæœŸè³‡æ–™]
    F -->|å¦| H[å›æ»¾ï¼šé‡æ–°æ¿€æ´»èˆŠè³‡æ–™]
    G --> I[å®Œæˆæ›´æ–°]
    H --> J[éŒ¯èª¤è™•ç†]
```

### éšæ®µè©³è§£

#### éšæ®µ 1: æ¨™è¨˜ç¾æœ‰è³‡æ–™
```sql
UPDATE listings SET isActive = false, updatedAt = NOW() WHERE isActive = true;
```

#### éšæ®µ 2: çˆ¬å–ä¸¦åŒ¯å…¥æ–°è³‡æ–™
- çˆ¬èŸ²åŸ·è¡Œï¼Œç”¢ç”Ÿæœ€æ–°è³‡æ–™
- æ–°è³‡æ–™è‡ªå‹•æ¨™è¨˜ç‚º `isActive = true`
- å¦‚æœçˆ¬å–å¤±æ•—ï¼ŒèˆŠè³‡æ–™ä»ç„¶å¯ç”¨

#### éšæ®µ 3: æ™ºæ…§æ¸…ç†
- **ç°¡å–®æ¸…ç†**ï¼šåˆªé™¤ N å¤©å‰çš„ inactive è³‡æ–™
- **æ™ºæ…§æ¸…ç†**ï¼šä¿ç•™æœ‰é€šå‹¤æ™‚é–“çš„ inactive è³‡æ–™

## ğŸ›¡ï¸ å®‰å…¨æ©Ÿåˆ¶

### 1. åŸå­æ€§æ“ä½œ
- å…ˆæ¨™è¨˜å¾ŒåŒ¯å…¥ï¼Œç¢ºä¿è³‡æ–™ä¸€è‡´æ€§
- å¤±æ•—æ™‚è‡ªå‹•å›æ»¾æ©Ÿåˆ¶

### 2. è³‡æ–™å¯è¦‹æ€§æ§åˆ¶
æ‰€æœ‰ API ç«¯é»åªè¿”å› `isActive: true` çš„è³‡æ–™ï¼š
```typescript
const where = {
  isActive: true,  // åªé¡¯ç¤º active è³‡æ–™
  // ... å…¶ä»–æ¢ä»¶
};
```

### 3. éŒ¯èª¤æ¢å¾©
```typescript
// å›æ»¾ï¼šé‡æ–°æ¿€æ´»ä¹‹å‰çš„è³‡æ–™
await prisma.listing.updateMany({
  where: { 
    isActive: false,
    updatedAt: { lt: new Date(startTime) }
  },
  data: { isActive: true }
});
```

## ğŸš€ API ç«¯é»

### æ‰¹æ¬¡æ›´æ–° API
```bash
POST /api/import/batch-update
Content-Type: multipart/form-data

# åƒæ•¸
file: JSON æª”æ¡ˆ
batchSize: æ‰¹æ¬¡å¤§å° (é è¨­: 1000)
keepOldDataDays: ä¿ç•™å¤©æ•¸ (é è¨­: 7)
preserveCommuteData: ä¿ç•™é€šå‹¤è³‡æ–™ (é è¨­: true)
```

### æ™ºæ…§æ¸…ç† API
```bash
POST /api/import/cleanup
Content-Type: application/json

{
  "keepDays": 7,        # ä¿ç•™å¤©æ•¸
  "smart": true         # æ™ºæ…§æ¸…ç†æ¨¡å¼
}
```

### è³‡æ–™çµ±è¨ˆ API
```bash
GET /api/import/stats

# å›æ‡‰
{
  "activeListings": 1500,
  "inactiveListings": 200,
  "totalCommuteData": 850,
  "dataFreshness": {
    "oldest": "2024-06-22T03:00:00.000Z",
    "newest": "2024-06-29T03:00:00.000Z"
  },
  "healthScore": "healthy"
}
```

## â° è‡ªå‹•åŒ–åŸ·è¡Œ

### Cron Job é…ç½®

#### æ¯æ—¥æ›´æ–°ï¼ˆæ¨è–¦ï¼‰
```bash
# æ¯å¤©å‡Œæ™¨ 3:00 åŸ·è¡Œï¼Œä¿ç•™ 7 å¤©èˆŠè³‡æ–™
0 3 * * * cd /path/to/rentrent/apps/crawler && python3 daily_update.py --cleanup-days=7 >> logs/cron.log 2>&1
```

#### é€±åº¦æ·±åº¦æ¸…ç†
```bash
# æ¯é€±æ—¥å‡Œæ™¨ 2:00 åŸ·è¡Œï¼Œåªä¿ç•™ 3 å¤©è³‡æ–™
0 2 * * 0 cd /path/to/rentrent/apps/crawler && python3 daily_update.py --cleanup-days=3 >> logs/cron_weekly.log 2>&1
```

#### å¥åº·æª¢æŸ¥
```bash
# æ¯å°æ™‚æ¸¬è©¦ï¼ˆå¯é¸ï¼‰
0 * * * * cd /path/to/rentrent/apps/crawler && python3 daily_update.py --test >> logs/health_check.log 2>&1
```

### NPM è…³æœ¬

```bash
# æ¸¬è©¦æ¨¡å¼
pnpm crawler:test

# æ­£å¼æ›´æ–°
pnpm crawler:update

# æ‰‹å‹•æŒ‡å®šåƒæ•¸
cd apps/crawler && python daily_update.py --cleanup-days=7 --backend-url=http://localhost:8000
```

## ğŸ“Š æ¯æ—¥æ›´æ–°è…³æœ¬åŠŸèƒ½

### åŸ·è¡Œæµç¨‹
1. **çˆ¬å–éšæ®µ**ï¼šåŸ·è¡Œçˆ¬èŸ²æ”¶é›†æœ€æ–°è³‡æ–™
2. **æ›´æ–°éšæ®µ**ï¼šä½¿ç”¨è»Ÿåˆªé™¤ç­–ç•¥æ‰¹æ¬¡æ›´æ–°è³‡æ–™åº«
3. **æ¸…ç†éšæ®µ**ï¼šæ™ºæ…§æ¸…ç†éæœŸè³‡æ–™
4. **å ±å‘Šéšæ®µ**ï¼šç”Ÿæˆè©³ç´°çš„æ›´æ–°å ±å‘Š

### åƒæ•¸é¸é …
```bash
python daily_update.py [OPTIONS]

é¸é …:
  --test                æ¸¬è©¦æ¨¡å¼ï¼ˆä¸åŸ·è¡Œå¯¦éš›æ“ä½œï¼‰
  --cleanup-days INT    ä¿ç•™å¹¾å¤©çš„èˆŠè³‡æ–™ï¼ˆé è¨­7å¤©ï¼‰
  --batch-size INT      æ‰¹æ¬¡è™•ç†å¤§å°ï¼ˆé è¨­1000ï¼‰
  --backend-url TEXT    å¾Œç«¯APIç¶²å€ï¼ˆé è¨­localhost:8000ï¼‰
```

### æ—¥èªŒè¨˜éŒ„
- è‡ªå‹•ç”Ÿæˆæ—¥æœŸå‘½åçš„æ—¥èªŒæª”æ¡ˆ
- è¨˜éŒ„è©³ç´°çš„åŸ·è¡Œéç¨‹å’Œçµ±è¨ˆè³‡æ–™
- éŒ¯èª¤è¿½è¹¤å’Œèª¿è©¦è³‡è¨Š

## ğŸ’¡ æ™ºæ…§æ¸…ç†ç­–ç•¥

### ç°¡å–®æ¸…ç†
åˆªé™¤ N å¤©å‰çš„æ‰€æœ‰ inactive è³‡æ–™åŠå…¶ç›¸é—œé€šå‹¤æ™‚é–“ã€‚

### æ™ºæ…§æ¸…ç†ï¼ˆæ¨è–¦ï¼‰
- **åˆªé™¤**ï¼šç„¡é€šå‹¤æ™‚é–“è³‡æ–™çš„èˆŠç‰©ä»¶
- **ä¿ç•™**ï¼šæœ‰é€šå‹¤æ™‚é–“è³‡æ–™çš„èˆŠç‰©ä»¶
- **å„ªå‹¢**ï¼šä¿è­·å·²æŠ•å…¥é‹ç®—æˆæœ¬çš„å¯¶è²´è³‡æ–™

```typescript
// æ™ºæ…§æ¸…ç†é‚è¼¯
const listingsToDelete = await prisma.listing.findMany({
  where: {
    isActive: false,
    updatedAt: { lt: cutoffDate },
    commuteTimes: { none: {} }  // æ²’æœ‰é€šå‹¤æ™‚é–“è³‡æ–™
  }
});

const listingsToPreserve = await prisma.listing.count({
  where: {
    isActive: false,
    updatedAt: { lt: cutoffDate },
    commuteTimes: { some: {} }  // æœ‰é€šå‹¤æ™‚é–“è³‡æ–™
  }
});
```

## ğŸ“ˆ å„ªå‹¢æ¯”è¼ƒ

| ç‰¹å¾µ | å…¨é‡åˆªé™¤ | è»Ÿåˆªé™¤ç­–ç•¥ |
|------|----------|------------|
| **è³‡æ–™å®‰å…¨** | âŒ é«˜é¢¨éšª | âœ… é›¶é¢¨éšª |
| **é€šå‹¤æ™‚é–“ä¿ç•™** | âŒ å…¨éƒ¨ä¸Ÿå¤± | âœ… æ™ºæ…§ä¿ç•™ |
| **æ›´æ–°æœŸé–“å¯ç”¨æ€§** | âŒ ç„¡è³‡æ–™ | âœ… æŒçºŒå¯ç”¨ |
| **éŒ¯èª¤æ¢å¾©** | âŒ ç„¡æ³•å›æ»¾ | âœ… è‡ªå‹•å›æ»¾ |
| **è³‡æ–™å“è³ª** | âŒ ä¸å¯æ§ | âœ… å¯é©—è­‰ |
| **é‹ç‡Ÿæˆæœ¬** | âŒ é«˜ | âœ… ä½ |
| **ç¶­è­·è¤‡é›œåº¦** | âœ… ç°¡å–® | âš ï¸ ä¸­ç­‰ |

## ğŸ”§ å¯¦ä½œæª”æ¡ˆ

### å¾Œç«¯ç›¸é—œ
- `apps/backend/src/services/importService.ts` - æ ¸å¿ƒé‚è¼¯
- `apps/backend/src/routes/import.ts` - API ç«¯é»
- `apps/backend/src/controllers/listings.controller.ts` - è³‡æ–™éæ¿¾

### çˆ¬èŸ²ç›¸é—œ
- `apps/crawler/daily_update.py` - æ¯æ—¥æ›´æ–°ä¸»è…³æœ¬
- `apps/crawler/crontab-example.txt` - Cron é…ç½®ç¯„ä¾‹

### é…ç½®ç›¸é—œ
- `package.json` - NPM è…³æœ¬
- `apps/backend/prisma/schema.prisma` - è³‡æ–™åº«æ¨¡å‹

## ğŸš¨ æ³¨æ„äº‹é …

### éƒ¨ç½²å‰æª¢æŸ¥
1. âœ… ç¢ºä¿è³‡æ–™åº«å‚™ä»½
2. âœ… æ¸¬è©¦æ¨¡å¼é©—è­‰æµç¨‹
3. âœ… ç›£æ§ç³»çµ±è¨­ç½®
4. âœ… éŒ¯èª¤é€šçŸ¥é…ç½®

### ç›£æ§æŒ‡æ¨™
- æ¯æ—¥æ›´æ–°æˆåŠŸç‡
- è³‡æ–™æ–°é®®åº¦
- éŒ¯èª¤ç‡å’Œæ¢å¾©æ™‚é–“
- ç£ç¢Ÿç©ºé–“ä½¿ç”¨

### ç¶­è­·å»ºè­°
- å®šæœŸæª¢æŸ¥æ—¥èªŒæª”æ¡ˆå¤§å°
- ç›£æ§ inactive è³‡æ–™ç´¯ç©
- é©æ™‚èª¿æ•´æ¸…ç†ç­–ç•¥åƒæ•¸
- å‚™ä»½é‡è¦çš„é€šå‹¤æ™‚é–“è³‡æ–™

## ğŸ“š ç›¸é—œæ–‡æª”

- [Prisma è»Ÿåˆªé™¤æŒ‡å—](https://www.prisma.io/docs/concepts/components/prisma-client/crud#deleting-records)
- [Cron è¡¨é”å¼èªæ³•](https://crontab.guru/)
- [Docker Compose æœ€ä½³å¯¦è¸](https://docs.docker.com/compose/best-practices/)

---

**æ­¤ç­–ç•¥ç‚ºç§Ÿå±‹å¹³å°è³‡æ–™æ›´æ–°çš„æœ€ä½³å¯¦è¸ï¼Œç¢ºä¿é«˜å¯ç”¨æ€§å’Œè³‡æ–™å®‰å…¨æ€§ã€‚** 